<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>黑白幾何遊戲 R3 (加速版)</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
            touch-action: none; /* 禁止預設觸控行為 */
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            border: 2px solid #333;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }

        /* UI 層 */
        #ui-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 15px;
            box-sizing: border-box;
            z-index: 10;
        }

        .hud-text {
            color: #fff;
            font-size: 16px;
            text-shadow: 1px 1px 0 #000;
            pointer-events: auto;
        }

        /* 返回按鈕樣式 */
        #back-btn {
            pointer-events: auto;
            background: #fff;
            color: #000;
            border: none;
            padding: 5px 10px;
            font-weight: bold;
            font-family: inherit;
            display: none; /* 預設隱藏，遊戲中顯示 */
            width: fit-content;
            margin-bottom: 10px;
        }

        #center-msg {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0,0,0,0.85);
            padding: 20px;
            border: 1px solid white;
            display: block; /* 初始顯示 */
            pointer-events: auto;
        }

        /* 隱藏關卡專用音量滑桿 */
        #volume-control {
            display: none;
            width: 80%;
            margin: 0 auto;
            pointer-events: auto;
        }

        /* 黑屏遮罩 */
        #black-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: #000;
            z-index: 9999;
            display: none;
            color: #111;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
        }
        
        button {
            cursor: pointer;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui-layer">
        <div>
            <button id="back-btn" onclick="returnToMenu()">回主選單</button>
            <div class="hud-text" id="top-hud">等待開始... (點3下)</div>
        </div>
        
        <div id="center-msg">
            <h2>黑白幾何 R3</h2>
            <p>主畫面操作指令：</p>
            <ul style="text-align:left; font-size:14px;">
                <li>點 3 下：開始遊戲</li>
                <li>點 5 下：儲存紀錄</li>
                <li>點 2 下：放棄/重置</li>
                <li>點 1 下：確定/購買</li>
            </ul>
            <p style="font-size:12px; color:#aaa;">提示：金幣越多，移動速度越快</p>
        </div>

        <div class="hud-text" style="text-align: center;">
            <input type="range" id="volume-control" min="0" max="100" value="100">
            <br>
            <span id="bottom-hud">金幣: 10</span>
            <br>
            <button id="screen-toggle-btn" style="pointer-events:auto; margin-top:5px; background:black; color:white; border:1px solid white;">隱藏螢幕</button>
        </div>
    </div>
</div>

<div id="black-screen">
    (模擬: 按下音量鍵喚醒)
</div>

<script>
/**
 * 遊戲全域變數與設定
 */
const CONFIG = {
    unitScale: 10, // 螢幕寬度的 1/10
    tapDelay: 400, // 判定多點擊的間隔(ms)
    coinCost: 100  // 換音效價格
};

const STATE = {
    scene: 'MENU', // MENU, GAME, HIDDEN, SHOP
    level: 1,
    maxLevels: 100,
    coins: 10, // 初始 10 金幣
    player: { x: 0, y: 0, vx: 0, vy: 0, soundType: 0 },
    shape: null, // 當前關卡的幾何資訊
    objects: [], // 金幣, 出口, 旗子
    volume: 100, // 模擬音量
    doorOpen: false,
    tapCount: 0,
    tapTimer: null,
    hiddenUnlocked: false
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// 音效系統 (Web Audio API + Speech API)
const AudioSys = {
    ctx: new (window.AudioContext || window.webkitAudioContext)(),
    
    playTone: function(freq, type, duration, vol=0.1) {
        if (this.ctx.state === 'suspended') this.ctx.resume();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    },

    // 語音播報 (Text-to-Speech)
    speak: function(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel(); 
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US'; 
            utterance.rate = 1.0; 
            window.speechSynthesis.speak(utterance);
        }
    },

    hit: () => AudioSys.playTone(150, 'sawtooth', 0.1, 0.3),
    step: () => {
        let baseFreq = 200 + (STATE.player.soundType * 100);
        AudioSys.playTone(baseFreq, 'square', 0.05, 0.1); 
    }, 
    coin: () => {
        AudioSys.playTone(1200, 'sine', 0.1, 0.2);
        setTimeout(() => AudioSys.playTone(1800, 'sine', 0.2, 0.2), 50);
    },
    door: () => AudioSys.playTone(100, 'triangle', 1.0, 0.4),
    win: () => {
        [523, 659, 783, 1046].forEach((f, i) => {
            setTimeout(() => AudioSys.playTone(f, 'sine', 0.3, 0.3), i * 150);
        });
    },
    teleport: () => {
        AudioSys.playTone(800, 'sawtooth', 0.5, 0.3);
        setTimeout(() => Audio